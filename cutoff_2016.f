C     PROGRAM CUTOFF
C
C     CONVERTS COORDINATES AND HESSIAN
C     TO SPECIFIED SUBSET
C
C     IAN H. WILLIAMS (29 September 2011)
C
	  REAL*8 X(3,1000),FCOLD(4501500),FCNEW(4501500)
      INTEGER*1 KEEP(1000)
      CHARACTER*76 TITLE
! 04/03/14 PBW ADDED 'STOP' TO LIST OF VCHARACTER
      CHARACTER*4 LAST,IAT(1000),IA,STOP
      CHARACTER*1 IFK, YES
C
      DATA STOP /'STOP'/
      DATA LAST /'*   '/
      DATA YES /'*'/
C
      IR=5
      IW=6
C
!
      READ(IR,100) IS,IG,IF,TITLE
      WRITE(IW,100) IS,IG,IF,TITLE
      DO 1 I = 1,1000
    1 KEEP(I) = 0
      NATNEW=0
      IOLD=1
! 04/03/14 PBW: CHANGED FORMAT OF CARTESIAN INPUT
    2 READ(IR,101) IA,IFK,(X(J,IOLD),J=1,3)
	  X(J,IOLD)=(X(J,IOLD))
      IF(IA.EQ.LAST) GO TO 3
      IF(IFK.EQ.YES) THEN
         NATNEW = NATNEW + 1
         KEEP(IOLD) = 1
! PBW: TURN ON/OFF CONVERSION TO ANGSTROM
!        WRITE(IW,209) IA,IFK,(X(J,IOLD)*0.529,J=1,3)
         WRITE(IW,209) IA,IFK,(X(J,IOLD),J=1,3)
         WRITE(7,207) (X(J,IOLD),J=1,3)
      ENDIF
      IOLD = IOLD + 1
      GO TO 2
    3 WRITE(IW,209) LAST
      NATOLD = IOLD - 1
      NCOLD = NATOLD*3
      NCNEW = NATNEW*3
      NNCOLD = NCOLD *(NCOLD + 1)/2
      NNCNEW = NCNEW *(NCNEW + 1)/2
! 04/03/14 PBW: CHANGED FORMAT OF FC INPUT
      READ(IR,104) (FCOLD(L),L=1,NNCOLD)
      IIOLD = 0
      IINEW = 0
      DO 4 IATOLD = 1, NATOLD
      DO 4 IC = 1,3
      JHI = (IATOLD - 1)*3 + IC
      DO 4 JCOL = 1,JHI 
      IIOLD = IIOLD + 1
      IF(KEEP(IATOLD).EQ.0) GO TO 4
      JATOLD = ((JCOL - 1)/3) + 1
      IF(KEEP(JATOLD).EQ.0) GO TO 4
      IINEW = IINEW + 1
      FCNEW(IINEW) = FCOLD(IIOLD)
    4 CONTINUE
      IF(IINEW.EQ.NNCNEW) THEN
! 04/03/14 PBW CHANGED FORMAT OF FC OUTPUT
        WRITE(IW,204) (FCNEW(I), I=1,NNCNEW)
!       WRITE(IW,209) STOP
!      ELSE
!        WRITE(IW,210)
        STOP
      ENDIF
      STOP
C
  100 FORMAT(3I2,A74)
  101 FORMAT(A4,A1,3F12.8)
  103 FORMAT(A4,A1,3E20.16)
  107 FORMAT(6F12.8)
  209 FORMAT(A4,A1,3F12.7)
  102 FORMAT(6F12.8)
  104 FORMAT(1X,3E20.16)
  204 FORMAT(3E20.10)
  210 FORMAT(1X,'ERROR')
  207 FORMAT(3F12.7)
      END
